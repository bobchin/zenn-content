---
title: "TTLでCPU"
emoji: "😽"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["CPU", "TTL"]
published: false
---

## Links

https://www.circuitlab.com/

https://making-cpu.github.io/archive/02_02_EN_gelou.pdf

https://elchika.com/article/a2dfc7e9-70ac-4879-bcbd-2046209ef2fb/

[CPUの創りかた](https://www.amazon.co.jp/dp/4839909865)

https://fumimaker.net/entry/2019/05/21/232344

https://seibe.jp/td4/

https://kikb.web.fc2.com/TD4/

[作ろう! CPU](https://www.amazon.co.jp/%E4%BD%9C%E3%82%8D%E3%81%86-CPU-%E5%9F%BA%E7%A4%8E%E3%81%8B%E3%82%89%E7%90%86%E8%A7%A3%E3%81%99%E3%82%8B%E3%82%B3%E3%83%B3%E3%83%94%E3%83%A5%E3%83%BC%E3%82%BF%E3%83%BC%E3%81%AE%E3%81%97%E3%81%8F%E3%81%BF-%E4%B8%8A%E5%8E%9F-%E5%91%A8/dp/4839968519/ref=pd_sbs_d_sccl_2_10/357-8294149-0144950?pd_rd_w=TeKWb&content-id=amzn1.sym.c0889d40-54df-4be4-b1c5-43522a3d0a92&pf_rd_p=c0889d40-54df-4be4-b1c5-43522a3d0a92&pf_rd_r=1ZWQS767AMYEV3JEG5P3&pd_rd_wg=2cd3p&pd_rd_r=096debd3-3c86-4e15-9dff-a7675108f05b&pd_rd_i=4839968519&psc=1)

http://zob.club/zob/antac3/

http://zob.club/zob/antac4/

[TTLアプリケーションマニュアル](https://www.sun-elle.com/pdf/2_digital/ttl_aplicationm_manyual.pdf)

## メモ

- CPU 構成
  - オペレータ
    - 加算/減算器
    - 乗算器
    - 算術論理演算器(ALU)
    - 複合型演算器
  - レジスタ
    - レジスタ
    - シフトレジスタ
    - カウンタ(psc)
  - 命令デコーダ
    - ラインデコーダ
    - ゲート
  - I/O
  - データバス

- IC
  - オペレータ
    - 74HC283
  - レジスタ
    - 74HC173
      - 74HC194(+1デコーダ)
      - 74HC161/163(+シフトデコーダ)
  - 命令デコーダ
    - 74HC138/139
  - データバス
    - 74HC245
    - 74HC151/153/157/158
  - I/O
    - 74HC148
    - 74HC4511

## TC4

- CPUの基本動作

  1. 命令フェッチ: プログラムカウンタに従って命令をメモリから読み出す
  2. デコード　　: 命令を解読
  3. 実行　　　　: デコード結果に応じて実際の演算をする
  4. ストア　　　: 演算結果を格納

- クロック
  上記の動作をクロックに合わせて繰り返す

- 4bit CPU
  最大で $2^4 = 16$ までのプログラムを扱う

### 論理回路

- NOT(インバータ)

![NOT](https://upload.wikimedia.org/wikipedia/commons/9/9f/Not-gate-en.svg =120x)

    | 入力 | 出力 |
    | :--: | :--: |
    |  L   |  H   |
    |  H   |  L   |

- AND(論理積)

![AND](https://upload.wikimedia.org/wikipedia/commons/0/03/AND-gate-US.png)

    | 入力(A) | 入力(B) | 出力(Y) |
    | :-----: | :-----: | :-----: |
    |    L    |    L    |    L    |
    |    L    |    H    |    L    |
    |    H    |    L    |    L    |
    |    H    |    H    |    H    |

- OR(論理和)

![OR](https://upload.wikimedia.org/wikipedia/commons/b/b9/OR-gate-US.png)

    | 入力(A) | 入力(B) | 出力(Y) |
    | :-----: | :-----: | :-----: |
    |    L    |    L    |    L    |
    |    L    |    H    |    H    |
    |    H    |    L    |    H    |
    |    H    |    H    |    H    |

- NAND

![NAND](https://upload.wikimedia.org/wikipedia/commons/d/d3/NAND-gate-US.png)

    | 入力(A) | 入力(B) | 出力(Y) |
    | :-----: | :-----: | :-----: |
    |    L    |    L    |    H    |
    |    L    |    H    |    H    |
    |    H    |    L    |    H    |
    |    H    |    H    |    L    |

- 他入力ゲート

  3入力NANDの場合

    | 入力(A) | 入力(B) | 入力(C) | 出力(Y) |
    | :-----: | :-----: | :-----: | :-----: |
    |    L    |    L    |    L    |    H    |
    |    L    |    L    |    H    |    H    |
    |    L    |    H    |    L    |    H    |
    |    L    |    H    |    H    |    H    |
    |    H    |    L    |    L    |    H    |
    |    H    |    L    |    H    |    H    |
    |    H    |    H    |    L    |    H    |
    |    H    |    H    |    H    |    L    |

### CMOSの注意点

- 使用しないゲートについて

  **入力側** は、微妙な電圧も反応してしまう可能性があり、
  不用意に電圧が入って電力を消費する可能性があるので、電源電圧かGNDに接続しておく必要がある。

- 静電気

  置く場所にあらかじめ触って放電しておく

- 電源

  ACアダプタは、安定化されていないことが多いので使えない

- パスコン

  H/L 切替のスイッチング速度に電源が追いつかない。
  0.1μF のセラミックコンデンサが電源とGNDの間になるべくICに近いところに必要。
　これはICごとに配置する。

  上記とは別に基盤上に1個 100μF の電解コンデンサを配置。

### リセットとスイッチ

- プルアップ抵抗

  1k ～ 100k Ω程度の抵抗

- チャタリング防止

  - 時定数

    時定数[sec] = R[Ω] x C[F]

    ex) 10kΩの抵抗と10μFのコンデンサの場合 $(10 * 10^3) * (10 * 10^{-6}) = 10 * 10^{-3} = 100m [sec]$

    電圧の変位は $E(1 - e^{-\frac{t}{CR}})$ なので、$1 - \frac{1}{e} = 1 - 0.37 = 0.63$ となり約63%程度になる時間を表す

  - シュミットトリガ

    時定数を使ってチャタリングを防止するために ON/OFF をゆっくりした場合にも、入力を正常に扱える

### クロック

  1Hz とする。
  5V電源で 2.5V をしきい値とすると、7.5V ～ -2.5V の範囲で電圧がかかる。
  周期の半分がコンデンサに電圧が溜まる/放電する時間となり、
  7.5V -> 2.5V (1/3になる=約33%になる)
  $e^{-\frac{t}{CR}} = 0.33 => \frac{t}{CR} = -log 0.33 \fallingdotseq 1.1 => t \fallingdotseq (1.1 * CR) * 2$
  余裕みて $t \fallingdotseq 3.0 * CR$ と考える。
  1Hz の場合は、$t = 1 => CR = 1/3 = 0.33$ になる組み合わせを考える。
  R = 33kΩ, C = 10μF => $33 * 10^3 * 10 * 10^{-6} = 330 * 10^{-3}$

### ROM

- データバス
  1度にデータを受け渡すサイズになる。8bit毎にやり取りする場合は、1bit毎に1本必要なので8本必要になる。

- アドレスバス
  保存するデータサイズに依存する。総データサイズ / データバスサイズ 分のアドレス数が必要になる。
  128bit(16byte)のデータサイズの場合は、128 / 8 = 16 個分のアドレスサイズが必要になるので、4本必要になる
  ($16 = 2^4$ ※16種類は4本あれば表せる)

- アドレスの変換
  4bit で 16 個分のアドレスを表せる。4bitで表されたアドレスから、16個のうち1つを選択する。

  |  D  |  C  |  B  |  A  | SELECT LOW |
  | :-: | :-: | :-: | :-: | :--------: |
  |  L  |  L  |  L  |  L  |     Y0     |
  |  L  |  L  |  L  |  H  |     Y1     |
  |  L  |  L  |  H  |  L  |     Y2     |
  |  L  |  L  |  H  |  H  |     Y3     |
  |  L  |  H  |  L  |  L  |     Y4     |
  |  L  |  H  |  L  |  H  |     Y5     |
  |  L  |  H  |  H  |  L  |     Y6     |
  |  L  |  H  |  H  |  H  |     Y7     |
  |  H  |  L  |  L  |  L  |     Y8     |
  |  H  |  L  |  L  |  H  |     Y9     |
  |  H  |  L  |  H  |  L  |    Y10     |
  |  H  |  L  |  H  |  H  |    Y11     |
  |  H  |  H  |  L  |  L  |    Y12     |
  |  H  |  H  |  L  |  H  |    Y13     |
  |  H  |  H  |  H  |  L  |    Y14     |
  |  H  |  H  |  H  |  H  |    Y15     |


### CPU

- 4bit CPU
  4bit を単位としてデータを扱うということ

- レジスタ(4bit)
  - A: 演算かつメモリー用(4bit)
  - B: 演算かつメモリー用(4bit)
  - C: キャリーフラグ(1bit)
  - PC: プログラムカウンタ(4bit)
  - 入力ポート(4bit)
  - 出力ポート(4bit)

- 命令フォーマット(8bit)
  - 上位4ビット: オペレーションコード

    | コード | マシン語  | 内容                                       |
    | :----: | :-------- | :----------------------------------------- |
    |  0000  | ADD A, Im | A <= A + Im                                |
    |  0101  | ADD B, Im | B <= B + Im                                |
    |  0011  | MOV A, Im | A <= Im                                    |
    |  0111  | MOV B, Im | B <= Im                                    |
    |  0001  | MOV A, B  | A <= B                                     |
    |  0100  | MOV B, A  | B <= A                                     |
    |  1111  | JMP Im    | Im へジャンプ                              |
    |  1110  | JMC Im    | C がセットされていないときに Im へジャンプ |
    |  0010  | IN A      | 入力ポートから A へ転送                    |
    |  0110  | IN B      | 入力ポートから B へ転送                    |
    |  1001  | OUT B     | B を出力ポートへ転送                       |
    |  1011  | OUT Im    | Im を出力ポートへ転送                      |

  - 下位4ビット: イミディエイトコード(Im)
    命令に組み込まれたデータ

### CPU の仕組み

- 処理単位は 4bit
  4bit なので、0～15 までの16種類を扱える

  - A レジスタ

    |     |      |      |      |
    | --- | ---- | ---- | ---- |
    | bi3 | bit2 | bit1 | bit0 |
    | MSB |      |      | LSB  |

  - B レジスタ

    |     |      |      |      |
    | --- | ---- | ---- | ---- |
    | bi3 | bit2 | bit1 | bit0 |
    | MSB |      |      | LSB  |

- 数値の転送
  - MOV A, Im
  - MOV B, Im
- レジスタ間の転送
  - MOV A, B
  - MOV B, A
- 加算命令
  - ADD A, Im
  - ADD B, Im
- ジャンプ命令
  - JMP Im
- フラグ
  - ADD 後に決まる
  - ADD 後の値を15にすることで、指定した値以下かどうか判定できる
    - JMC Im
- プログラムカウンタ
- I/O
  - 入力命令
    - IN A
    - IN B
  - 出力命令
    - OUT B
    - OUT Im

### フリップフロップ

1bit の値を記憶することができる。
=> レジスタに使用することになる

入力・出力・クロックがあり、クロック(L -> H)のタイミングの入力の状態を保持する。
クリア(状態を0にする)とプリセット(状態を1にする)もある。

- 値を保持する方法
  - 入力に出力を接続する
  - クロックを止める

### データセレクタ

マルチプレクサとも言われる。

|  A  |  B  | C0  | C1  | C2  | C3  |  G  |  Y  |
| :-: | :-: | :-: | :-: | :-: | :-: | :-: | :-: |
|     |     |     |     |     |     |  H  |  L  |
|  L  |  L  |  L  |     |     |     |     |  L  |
|  L  |  L  |  H  |     |     |     |     |  H  |
|  H  |  L  |     |  L  |     |     |     |  L  |
|  H  |  L  |     |  H  |     |     |     |  H  |
|  L  |  H  |     |     |  L  |     |     |  L  |
|  L  |  H  |     |     |  H  |     |     |  H  |
|  H  |  H  |     |     |     |  L  |     |  L  |
|  H  |  H  |     |     |     |  H  |     |  H  |

### レジスタ

| CLR | LD  | ENP | ENT | QA  | QB  | QC  | QD  | メモ         |
| :-: | :-: | :-: | :-: | :-: | :-: | :-: | :-: | ------------ |
|  L  |     |     |     |  L  |  L  |  L  |  L  |              |
|  H  |  L  |     |     |  A  |  B  |  C  |  D  |              |
|  H  |  H  |     |  L  |     |     |     |     |              |
|  H  |  H  |  L  |     |     |     |     |     |              |
|  H  |  H  |  H  |  H  |     |     |     |     | カウント動作 |

- LD を LOW にすると値を取得する

- カウント機能を有効にする


### 転送の仕組み

- LOAD(0, 1, 2, 3) はレジスタの選択に使用している
- SELECT(A, B)は、データ転送元の選択に使用している

|  A  |  B  |     選択     |
| :-: | :-: | :----------: |
|  L  |  L  | C0(Aレジスタ) |
|  H  |  L  | C1(Bレジスタ) |
|  L  |  H  | C2(Cレジスタ) |
|  H  |  H  | C3(Dレジスタ) |

| LOAD0 | LOAD1 | LOAD2 | LOAD3 | 書き込み先 |
| :---: | :---: | :---: | :---: | :--------: |
|   L   |   H   |   H   |   H   | Aレジスタ  |
|   H   |   L   |   H   |   H   | Bレジスタ  |
|   H   |   H   |   L   |   H   | Cレジスタ  |
|   H   |   H   |   H   |   L   | Dレジスタ  |


### 加算器

|  A  |  B  | C(キャリー) | S（出力） |
| :-: | :-: | :---------: | :-------: |
|  0  |  0  |      0      |     0     |
|  0  |  1  |      0      |     1     |
|  1  |  0  |      0      |     1     |
|  1  |  1  |      1      |     0     |

$S = \overline{A} \cdot B + A \cdot \overline{B}$
$C = A \cdot B$

| Cin |  A  |  B  | C(キャリー) | S（出力） |
| :-: | :-: | :-: | :---------: | :-------: |
|  0  |  0  |  0  |      0      |     0     |
|  0  |  0  |  1  |      0      |     1     |
|  0  |  1  |  0  |      0      |     1     |
|  0  |  1  |  1  |      1      |     0     |
|  1  |  0  |  0  |      0      |     1     |
|  1  |  0  |  1  |      1      |     0     |
|  1  |  1  |  0  |      1      |     0     |
|  1  |  1  |  1  |      1      |     1     |

### フラグ

フリップフロップを使う

### プログラムカウンタ

カウンタ機能を有効にして、D レジスタを流用する

### I/O ポート

C レジスタを流用する

### 命令のデコード

- 出力(6bit)
  - SELECT A, SELECT B
  - LOAD0, LOAD1, LOAD2, LOAD3

- 入力(5bit)
  - オペレーションコード(4bit)
  - C フラグ

| 命令      | bit7 | bit6 | bit5 | bit4 | bit3 | bit2 | bit1 | bit0 |  C  | SEL B | SEL A | L0  | L1  | L2  | L3  |
| :-------- | :--: | :--: | :--: | :--: | :--: | :--: | :--: | :--: | :-: | :---: | :---: | :-: | :-: | :-: | :-: |
| MOV A, Im |  0   |  0   |  1   |  1   |      |      |      |      |  0  |   H   |   H   |  L  |  H  |  H  |  H  |
| MOV B, Im |  0   |  1   |  1   |  1   |      |      |      |      |  0  |   H   |   H   |  H  |  L  |  H  |  H  |
| MOV A, B  |  0   |  0   |  0   |  1   |  0   |  0   |  0   |  0   |  0  |   L   |   H   |  L  |  H  |  H  |  H  |
| MOV B, A  |  0   |  1   |  0   |  0   |  0   |  0   |  0   |  0   |  0  |   L   |   L   |  H  |  L  |  H  |  H  |
| ADD A, Im |  0   |  0   |  0   |  0   |      |      |      |      | 0/1 |   L   |   L   |  L  |  H  |  H  |  H  |
| ADD B, Im |  0   |  1   |  0   |  1   |      |      |      |      | 0/1 |   L   |   H   |  H  |  L  |  H  |  H  |
| IN A      |  0   |  0   |  1   |  0   |  0   |  0   |  0   |  0   |  0  |   H   |   L   |  L  |  H  |  H  |  H  |
| IN B      |  0   |  1   |  1   |  0   |  0   |  0   |  0   |  0   |  0  |   H   |   L   |  H  |  L  |  H  |  H  |
| OUT Im    |  1   |  0   |  1   |  1   |      |      |      |      |  0  |   H   |   H   |  H  |  H  |  L  |  H  |
| OUT B     |  1   |  0   |  0   |  1   |      |      |      |      |  0  |   L   |   H   |  H  |  H  |  L  |  H  |
| JMP Im    |  1   |  1   |  1   |  1   |      |      |      |      |  0  |   H   |   H   |  H  |  H  |  H  |  L  |
| JNC Im    |  1   |  1   |  1   |  0   |      |      |      |      |  0  |   H   |   H   |  H  |  H  |  H  |  L  |
| JNC Im    |  1   |  1   |  1   |  0   |      |      |      |      |  1  |       |       |  H  |  H  |  H  |  H  |


| 命令      | OP3 | OP2 | OP1 | OP0 |  C  | SEL B | SEL A | L0  | L1  | L2  | L3  |
| :-------- | :-: | :-: | :-: | :-: | :-: | :---: | :---: | :-: | :-: | :-: | :-: |
| MOV A, Im |  0  |  0  |  1  |  1  |     |   H   |   H   |  L  |  H  |  H  |  H  |
| MOV B, Im |  0  |  1  |  1  |  1  |     |   H   |   H   |  H  |  L  |  H  |  H  |
| MOV A, B  |  0  |  0  |  0  |  1  |     |   L   |   H   |  L  |  H  |  H  |  H  |
| MOV B, A  |  0  |  1  |  0  |  0  |     |   L   |   L   |  H  |  L  |  H  |  H  |
| ADD A, Im |  0  |  0  |  0  |  0  |     |   L   |   L   |  L  |  H  |  H  |  H  |
| ADD B, Im |  0  |  1  |  0  |  1  |     |   L   |   H   |  H  |  L  |  H  |  H  |
| IN A      |  0  |  0  |  1  |  0  |     |   H   |   L   |  L  |  H  |  H  |  H  |
| IN B      |  0  |  1  |  1  |  0  |     |   H   |   L   |  H  |  L  |  H  |  H  |
| OUT Im    |  1  |  0  |  1  |  1  |     |   H   |   H   |  H  |  H  |  L  |  H  |
| OUT B     |  1  |  0  |  0  |  1  |     |   L   |   H   |  H  |  H  |  L  |  H  |
| JMP Im    |  1  |  1  |  1  |  1  |     |   H   |   H   |  H  |  H  |  H  |  L  |
| JNC Im    |  1  |  1  |  1  |  0  |  0  |   H   |   H   |  H  |  H  |  H  |  L  |
| JNC Im    |  1  |  1  |  1  |  0  |  1  |       |       |  H  |  H  |  H  |  H  |


- SELECT B

  $OP1 = SEL B$

- SELECT A

  $OP0 \parallel OP3 = SEL A$

- LOAD 0

  $OP2 \parallel OP3 = LOAD 0$

- LOAD 1

  $\overline{OP2} \parallel OP3 = LOAD 1$

- LOAD 2

  $OP2 \parallel \overline{OP3} = LOAD 2$

- LOAD 3

  $(\overline{OP2}) \parallel (\overline{OP3}) \parallel (\overline{OP0} \cdot C) = LOAD 3$

- 最終


### ブール代数

| 法則             | 式                                                                                                             |
| :--------------- | :------------------------------------------------------------------------------------------------------------- |
| 結合法則         | $A + B = B + A \qquad A \cdot B = B \cdot A$                                                                   |
| 恒等法則         | $A + (B + C) = (A + B) + C \qquad A \cdot (B \cdot C) = (A \cdot B) \cdot C$                                   |
| 同一法則         | $A + 1 = 1 \qquad A \cdot 1 = A \qquad A + 0 = 0 \qquad A \cdot 0 = 0$                                         |
| 補元法則         | $A + \overline{A} = 1 \qquad A \cdot \overline{A} = 0$                                                         |
| 復元法則         | $\overline{\overline{A}} = A$                                                                                  |
| ド・モルガン法則 | $\overline{A + B} = \overline{A} \cdot \overline{B} \qquad \overline{A \cdot B} = \overline{A} + \overline{B}$ |
| 分配法則         | $A \cdot (B + C) = A \cdot B + A \cdot C \qquad A + (B \cdot C) = (A + B) \cdot (A + C)$                       |
| 吸収法則         | $A + A \cdot B = A \qquad A \cdot (A + B) = A$                                                                 |


### ICリスト

- 基本
  - 74HC04  : インバータ x6
  - 74HC08  : AND x4
  - 74HC32  : OR x4
  - 74HC00  : NAND x4
  - 74HC10  : 3入力AND x3

- 74HC14  : シュミットトリガインバータ x6
- 74HC540 : インバータ x8
- 74HC154 : 4-8 デコーダ
  - 74HC138 : 154がないため代替
- 74HC74  : フリップフロップ x2
- 74HC153 : 4-1データセレクタ x2
- 74HC161 : 同期4ビットカウンタ
- 74HC283 : 4ビットバイナリ全加算器
