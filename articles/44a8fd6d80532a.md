---
title: "gstreamer"
emoji: "üôå"
type: "tech" # tech: ÊäÄË°ìË®ò‰∫ã / idea: „Ç¢„Ç§„Éá„Ç¢
topics: [gstreamer, nodejs]
published: false
---

## Links

https://blog.logrocket.com/using-gstreamer-node-js/

## „Éó„É©„Ç∞„Ç§„É≥„Ç¢„Éº„Ç≠„ÉÜ„ÇØ„ÉÅ„É£

- „Éó„É≠„Éà„Ç≥„É´Âá¶ÁêÜ
- „ÇΩ„Éº„Çπ: Èü≥Â£∞„ÇÑÊò†ÂÉè
- „Éï„Ç©„Éº„Éû„ÉÉ„Éà: „Éë„Éº„Çµ, „Éï„Ç©„Éº„Éû„ÉÉ„Çø, „Éû„ÇØ„Çµ„Éº, „Éá„Éû„ÇØ„Çµ„Éº, „É°„Çø„Éá„Éº„Çø
- „Ç≥„Éº„Éá„ÉÉ„ÇØ
- „Éï„Ç£„É´„Çø: „Ç≥„É≥„Éê„Éº„Çø, „Éü„Ç≠„Çµ„Éº, „Ç®„Éï„Çß„ÇØ„Éà
- „Ç∑„É≥„ÇØ: Èü≥Â£∞„ÇÑÊò†ÂÉè

## nodejs „Åã„Çâ‰Ωø„ÅÜ

- GStreamer „Çí„Ç§„É≥„Çπ„Éà„Éº„É´ÔºàÈÄöÂ∏∏ÈÄö„ÇäÔºâ

- Nodejs „ÅÆÊ∫ñÂÇô

  ```bash
  npm install express
  ```

  ```js:index.js
  const express = require('express')
  const http = require('http')
  const net = require('net')
  const child = require('child_process')

  const app = express()
  app.use(express.static(__dirname + '/'))

  const httpServer = http.createServer(app)
  const port = 3000

  // „Éñ„É©„Ç¶„Ç∂Ë°®Á§∫
  app.get('/', (req, res) => {
    res.send('index.html')
  })

  // „Ç≥„Éç„ÇØ„Ç∑„Éß„É≥„ÇíÂÅúÊ≠¢„Åô„Çã
  app.post('/stop', (req, res) => {
    console.log('Connection closed using /stop endpoint.')
    if (gstMuxer != undefined) {
      gstMuxer.kill() // kill the GStreamer Pipeline
      gstMuxer = undefined
    }
    res.end()
  })

  // Êò†ÂÉè„Çπ„Éà„É™„Éº„É†„ÇíÈÄÅ‰ø°„Åô„Çã
  // 1. „ÇØ„É©„Ç§„É≥„Éà„Åã„Çâ /stream „Å´„Ç¢„ÇØ„Çª„Çπ
  // 2. tcpserver „ÇíÁîüÊàê„Åó„Å¶„ÄÅgstreamer„ÇíÂÆüË°å
  // 3. gstreamer „Åã„Çâ tcpserver „Å´Êò†ÂÉèÈÄÅ‰ø°
  // 4. tcpserver „Åã„Çâ„ÇØ„É©„Ç§„Ç¢„É≥„Éà„Å´„Åù„ÅÆ„Åæ„ÅæÊò†ÂÉèÈÄÅ‰ø°
  app.get('/stream', (req, res) => {
    res.writeHead(200, {
      'Content-Type': 'video/webm',
    })

    const tcpServer = net.createServer((socket) => {
      socket.on('data', (data) => {
        res.write(data)
      })
      socket.on('close', () => {
        console.log('Socket closed.')
        res.end()
      })
    })

    tcpServer.maxConnections = 1
    tcpServer.listen(() => {
      console.log('Connection started.')
      if (gstMuxer != undefined) {
        console.log('New GST pipeline rejected. because gstMuxer != undefined.')
        return
      }

      console.log('inside gstMuxer == undefined')
      const cmd = 'gst-launch-1.0'
      const args = getGstPipelineArguments(this)
      const gstMuxer = child.spawn(cmd, args)
      gstMuxer.stderr.on('data', onSpawnError)
      gstMuxer.on('exit', onSpawnExit)
    })
  })

  httpServer.listen(port)

  process.on('uncaughtException', (err) => console.log(err))

  function onSpawnError(data) {
    console.log(data.toString())
  }
  function onSpawnExit(code) {
    if (code != null) {
      console.log(`GStreamer error, exit code ${code}`)
    }
  }
  function getGstPipelineArguments(tcpServer) {
    const args = [
      'samplevideo.mp4', 'pattern=ball',
      '!', 'video/x-raw,width=320,height=240,framerate=100/1',
      '!', 'vpuenc_h264', 'bitrate=2000',
      '!', 'mp4mux', 'fragment-duration=10',
      '!', 'tcpclientsink', 'host=localhost',
      'port=' + tcpServer.address().port
    ]
    return args;
  }
  ```

  ```html:index.html
  <!DOCTYPE html>
  <head>
    <title>Gstreamer with NodeJS Demo</title>
    <meta name="viewport" content="width=device-width, initial-scale=0.9">
    <style>
      html, body {
        overflow: hidden;
      }
    </style>
    <script>
      function buffer() {
        const dStream = document.getElementById('vidStream')
        try {
          dStream.play()
        } catch(error) {
          console.log(error)
        }
      }
    </script>
  </head>
  <body onload="buffer()">
    <video id="vidStream" width="640" height="480" muted>
      <source src="/stream" type="video/mp4">
      <source src="/stream" type="video/webm">
      <source src="/stream" type="video/ogg">
      <!-- fallback -->
      Your browser does not support the video element.
    </video>
  </body>
  ```

## GStreamer Kit

https://github.com/repugraf/gst-kit

- Áí∞Â¢É
  - Node.js 16+
  - GStreamer 1.14+ (1.26+ Êé®Â•®)
  - Python 2.7 or 3x, pkg-config
  - GStreamer development packages and plugins

```bash
npm install gst-kit
```

- „Éó„É©„ÉÉ„Éà„Éï„Ç©„Éº„É†„Åî„Å®„ÅÆ„Ç§„É≥„Çπ„Éà„Éº„É´

- Ubuntu/Debian (Recommended for Production)

```bash
# Package Manager „Éë„Çø„Éº„É≥ #############################
sudo apt-get update

# Install GStreamer core development packages
sudo apt-get install -y \
  libgstreamer1.0-dev \
  libgstreamer-plugins-base1.0-dev \
  libgstreamer-plugins-bad1.0-dev \
  pkg-config

# Install GStreamer plugins (essential for most use cases)
sudo apt-get install -y \
  gstreamer1.0-plugins-base \
  gstreamer1.0-plugins-good \
  gstreamer1.0-plugins-bad \
  gstreamer1.0-plugins-ugly \
  gstreamer1.0-libav

# Install build tools
sudo apt-get install -y build-essential python3


# Cross-Platform Setup with setup-cpp „Éë„Çø„Éº„É≥ ##########
# Install build tools automatically
npx setup-cpp --compiler auto --pkg-config true

# Then install GStreamer packages
sudo apt-get update
sudo apt-get install -y \
  libgstreamer1.0-dev \
  libgstreamer-plugins-base1.0-dev \
  libgstreamer-plugins-bad1.0-dev \
  gstreamer1.0-plugins-base \
  gstreamer1.0-plugins-good \
  gstreamer1.0-plugins-bad \
  gstreamer1.0-plugins-ugly \
  gstreamer1.0-libav

#########################################################
# Á¢∫Ë™ç
pkg-config --cflags --libs gstreamer-1.0
gstreamer-1.0 --version
```
