---
title: "udp multicast"
emoji: "ğŸ™Œ"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: [udp, node]
published: true
---

## Links

https://stackoverflow.com/questions/14130560/nodejs-udp-multicast-how-to

https://gist.github.com/ciaranj/9056285

## Source

```js:multicast_udp.js
import dgram from 'node:dgram'
import os from 'os'

// settings ###############################################
const MULTICAST_IP = '225.1.0.0'
const MULTICAST_PORT = 12346
const CMD_GET_INFO = 'send_ip'
let is_debug = false
// ########################################################

// functions ##############################################

function log() {
  if (is_debug) {
    console.log.apply(null, arguments)
  }
}

// udp ãƒãƒ«ãƒã‚­ãƒ£ã‚¹ãƒˆã‚½ã‚±ãƒƒãƒˆã®åˆæœŸåŒ–
// on_message: ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å—ä¿¡æ™‚ã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ (msg, rinfo) => {}
function init_udp_socket(on_message = () => {}) {
  const socket = dgram.createSocket('udp4')

  socket.on('close', () => {
    log(`socket closed. ${socket.address().address}`)
  })

  socket.on('listening', () => {
    const address = socket.address()
    log(`UDP socket listening on ${address.address}:${address.port}`)

    socket.setBroadcast(true)
    socket.setMulticastTTL(128)
  })

  socket.on('message', (msg, rinfo) => {
    log(`get udp packet msg: [${msg}] from ${rinfo.address}:${rinfo.port}`)
  })
  socket.on('message', on_message)

  return socket
}

// IPã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å–å¾—ã™ã‚‹
// nicname: NIC ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ã‚¤ã‚¹å
function ip_address(nicname = null) {
  if (nicname === null) {
    nicname = (process.platform === 'win32')? "ã‚¤ãƒ¼ã‚µãƒãƒƒãƒˆ": "en0"
  }

  const nets = os.networkInterfaces()
  const net = nets[nicname]?.find((v) => v.family?.toLowerCase() == "ipv4")
  const res = !!net ? net.address: null
  log(`network interface is ${res}`)
  return res
}
// ########################################################

// UDP ã§ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡
// socket: udp socket
// msg: ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
function udp_send(socket, msg) {
  if (typeof msg !== 'string') {
    msg = JSON.stringify(msg)
  }
  socket.send(msg, 0, msg.length, MULTICAST_PORT, MULTICAST_IP)
  log(`send udp packet msg: [${msg}] to ${MULTICAST_IP}:${MULTICAST_PORT}`)
}

// IP ãŠçŸ¥ã‚‰ã›ã‚³ãƒãƒ³ãƒ‰ã‚’é€ä¿¡ã™ã‚‹
function send_get_info() {
  if (server !== null) {
    udp_send(server, CMD_GET_INFO)
  }
}

// ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒã‚³ãƒãƒ³ãƒ‰ã‹ã©ã†ã‹
function get_msg(msg) {
  msg = msg.toString()
  return (msg === CMD_GET_INFO)? false: JSON.parse(msg)
}

// udp ã‚µãƒ¼ãƒã‚’åˆæœŸåŒ–ã™ã‚‹
let server = null
function init_server({ on_message, debug } = { on_message: () => {}, debug: false }) {
  is_debug = debug
  if (server === null) {
    server = init_udp_socket(on_message)
    server.bind(MULTICAST_PORT, () => {
      server.addMembership(MULTICAST_IP)  // ãƒãƒ«ãƒã‚­ãƒ£ã‚¹ãƒˆå—ä¿¡ã‚’æœ‰åŠ¹ã«ã™ã‚‹
    })
  }
  return server
}

// udp ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’åˆæœŸåŒ–ã™ã‚‹
function init_client({ if_name, debug } = { if_name: null, debug: false }) {
  is_debug = debug
  const ip = ip_address(if_name)

  const on_message = (msg) => {
    // ã‚³ãƒãƒ³ãƒ‰ã‚’å—ä¿¡ã—ãŸã‚‰é€ä¿¡å…ˆã«å†…å®¹ã‚’è¿”ã™
    if (msg.toString() === CMD_GET_INFO) {
      const res_msg = { ip: ip, name: os.hostname() }
      udp_send(client, res_msg)
    }
  }
  const client = init_udp_socket(on_message)

  client.bind(MULTICAST_PORT, ip, () => {
    client.addMembership(MULTICAST_IP)  // ãƒãƒ«ãƒã‚­ãƒ£ã‚¹ãƒˆå—ä¿¡ã‚’æœ‰åŠ¹ã«ã™ã‚‹
  })
}

export {
  init_server,
  init_client,
  send_get_info,
  get_msg,
  udp_send,
}
```

```js:server.js
import {
  init_server,
  get_msg,
  send_get_info,
} from "./multicast_udp.js"

const debug = false
const interval = 2000

function on_message(msg) {
  // è¤‡æ•°æ©Ÿå™¨ã‹ã‚‰ã‚³ãƒãƒ³ãƒ‰çµæœã‚’å—ä¿¡
  msg = get_msg(msg)
  if (msg !== false) {
    console.log("get message:", msg)
  }
}

// main
init_server({
  on_message,
  debug,
})

setTimeout(() => send_get_info(), interval)
```

```js:client.js
import {
  init_client,
} from "./multicast_udp.js"

const debug = false
const if_name = "ã‚¤ãƒ¼ã‚µãƒãƒƒãƒˆ 2"

init_client({
  if_name,
  debug,
})
```
