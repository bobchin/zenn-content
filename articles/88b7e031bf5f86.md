---
title: "udp multicast"
emoji: "ğŸ™Œ"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: [udp, node]
published: false
---

## Links

https://stackoverflow.com/questions/14130560/nodejs-udp-multicast-how-to

https://gist.github.com/ciaranj/9056285

## Source

```js:multicast_udp.js
import dgram from 'node:dgram'
import os from 'os'

// settings ###############################################
const multicast_ip = '225.1.0.0'
const multicast_port = 12345
const cmd_get_info = 'send_ip'
let is_debug = false
// ########################################################

// functions ##############################################

function log() {
  if (is_debug) {
    console.log.apply(null, arguments)
  }
}

// udp ãƒãƒ«ãƒã‚­ãƒ£ã‚¹ãƒˆã‚½ã‚±ãƒƒãƒˆã®åˆæœŸåŒ–
// on_message: ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å—ä¿¡æ™‚ã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ (msg, rinfo) => {}
function udp_socket(on_message = () => {}) {
  const socket = dgram.createSocket('udp4')

  socket.on('listening', () => {
    const address = socket.address()
    log(`UDP socket listening on ${address.address}:${address.port}`)

    socket.setBroadcast(true)
    socket.setMulticastTTL(128)
  })

  socket.on('message', (msg, rinfo) => {
    log(`get udp packet msg: ${msg} from ${rinfo.address}:${rinfo.port}`)
  })
  socket.on('message', on_message)

  return socket
}

// IPã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å–å¾—ã™ã‚‹
// nicname: NIC ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ã‚¤ã‚¹å
function ip_address(nicname = null) {
  if (nicname === null) {
    nicname = (process.platform === 'win32')? "ã‚¤ãƒ¼ã‚µãƒãƒƒãƒˆ": "en0"
  }

  const nets = os.networkInterfaces()
  const net = nets[nicname]?.find((v) => v.family?.toLowerCase() == "ipv4")
  const res = !!net ? net.address: null
  log(`network interface is ${res}`)
  return res
}
// ########################################################

function debug(value = true) {
  is_debug = value
}

// UDP ã§ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡
// socket: udp socket
// msg: ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
function udp_send(socket, msg) {
  // log(`send udp packet msg: ${msg} to ${multicast_port}:${multicast_ip}`)
  socket.send(msg, 0, msg.length, multicast_port, multicast_ip)
}

// IP ãŠçŸ¥ã‚‰ã›ã‚³ãƒãƒ³ãƒ‰ã‚’é€ä¿¡ã™ã‚‹
function send_get_info() {
  if (server !== null) {
    udp_send(server, cmd_get_info)
  }
}

// ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒã‚³ãƒãƒ³ãƒ‰ã‹ã©ã†ã‹
function get_msg(msg) {
  msg = msg.toString()
  return (msg === cmd_get_info)? false: JSON.parse(msg)
}

// udp ã‚µãƒ¼ãƒã‚’åˆæœŸåŒ–ã™ã‚‹
let server = null
function init_server(cb = () => {}) {
  if (server === null) {
    server = udp_socket(cb)
    server.bind(multicast_port, () => {
      server.addMembership(multicast_ip)  // ãƒãƒ«ãƒã‚­ãƒ£ã‚¹ãƒˆå—ä¿¡ã‚’æœ‰åŠ¹ã«ã™ã‚‹
    })
  }
  return server
}

// udp ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’åˆæœŸåŒ–ã™ã‚‹
function init_client(nicname = null) {
  const ip = ip_address(nicname)
  const response = {
    ip: ip,
    name: os.hostname(),
  }

  const client = udp_socket((msg, rinfo) => {
    // ã‚³ãƒãƒ³ãƒ‰ã‚’å—ä¿¡ã—ãŸã‚‰é€ä¿¡å…ˆã«å†…å®¹ã‚’è¿”ã™
    if (msg.toString().toLowerCase() === cmd_get_info) {
      const res_msg = JSON.stringify(response)
      udp_send(client, res_msg)
    }
  })

  client.bind(multicast_port, ip, () => {
    client.addMembership(multicast_ip)  // ãƒãƒ«ãƒã‚­ãƒ£ã‚¹ãƒˆå—ä¿¡ã‚’æœ‰åŠ¹ã«ã™ã‚‹
  })
}

export {
  init_server,
  init_client,
  send_get_info,
  get_msg,
  udp_send,
  debug,
}
```

```js:server.js
import { init_server, debug, get_msg, send_get_info } from "./multicast_udp.js"

const is_debug = false
const interval = 2000

debug(is_debug)
init_server((msg) => {
  // è¤‡æ•°æ©Ÿå™¨ã‹ã‚‰ã‚³ãƒãƒ³ãƒ‰çµæœã‚’å—ä¿¡
  msg = get_msg(msg)
  if (msg !== false) {
    console.log(get_msg(msg))
  }
})
setInterval(() => send_get_info(), interval)
```

```js:client.js
import { init_client, debug } from "./multicast_udp.js"

const is_debug = false
const nic_interface = "ã‚¤ãƒ¼ã‚µãƒãƒƒãƒˆ"

debug(is_debug)
init_client(nic_interface)
```
