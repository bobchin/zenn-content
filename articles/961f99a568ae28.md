---
title: "USBのまとめ"
emoji: "🎃"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["USB"]
published: false
---

## Links

https://www.usb.org/developers

https://www.marubun.co.jp/technicalsquare/10381/

https://www.marubun.co.jp/technicalsquare/10483/

http://www.picfun.com/usb00.html

https://github.com/micropython/micropython-lib/tree/master/micropython/usb#readme

## 仕様

- 階層は5段まで
- 接続可能台数は127台(ホストはアドレスを127個まで振れる)
  - 台数としては、デバイスとハブそれぞれ1台とカウントする
- 方向は常にホストからみたものと考える
  - IN : デバイス -> ホスト の方向（ホストの入力）
  - OUT: ホスト -> デバイス の方向（ホストの出力）


---

### 信号線

- USB 1.0/2.0: D+/D- のみ                    => 半二重
- USB 3.0/3.1: D+/D-, TX+/TX-, RX+/RX-       => 全二重
- USB3.2/4.0 : D+/D-, TX+/TX- x2, RX+/RX- x2 => 全二重
- CC: Control Channel 接続の裏表判定

---

### 転送規格

- USB Low Speed   : 1.5Mbps
  - USB1.1
- USB Full Speed  : 12Mbps
  - USB1.1
- USB High Speed  : 480Mbps
  - USB2.0
- USB Super Speed : 5Gbps
  - USB3.0
  - USB3.1 Gen1
  - USB3.2 Gen1
- USB Super Speed+: 10Gbps
  - USB3.1 Gen2
  - USB3.2 Gen2
  - USB3.2 Gen1x2
  - USB4.0 Gen2
- 20Gbps
  - USB 3.2 Gen2x2
  - USB4.0 Gen2x2
  - USB4 Gen3
- 40Gbpx
  - USB4 Gen3x2
- 80Gbpx
  - USB4 2.0

|      USB4      |      USB3.2      |     USB3.1     |     USB3.0     | USB2.0 | USB1.1 | 最大転送速度 |
| :------------: | :--------------: | :------------: | :------------: | :----: | :----: | :----------: |
|       -        |        -         |       -        |       -        |   -    | USB1.1 |    12Mbps    |
|       -        |        -         |       -        |       -        | USB2.0 |   -    |   480Mbps    |
|       -        |  USB3.2<br>Gen1  | USB3.1<br>Gen1 | USB3.0<br>Gen1 |   -    |   -    |    5Gbps     |
|  USB4<br>Gen2  |  USB3.2<br>Gen2  | USB3.1<br>Gen2 |       -        |   -    |   -    |    10Gbps    |
|       -        | USB3.2<br>Gen1x2 |       -        |       -        |   -    |   -    |    10Gbps    |
| USB4<br>Gen2x2 | USB3.2<br>Gen2x2 |       -        |       -        |   -    |   -    |    20Gbps    |
|  USB4<br>Gen3  |        -         |       -        |       -        |   -    |   -    |    20Gbps    |
| USB4<br>Gen3x2 |        -         |       -        |       -        |   -    |   -    |    40Gbps    |

:::message
Genごとで速度が決まっていて、x2 で単純に2倍になる。x2 は、USB3.2 以降から

- Gen1 = 5Gbps
- Gen2 = 10Gbps
- Gen3 = 20Gbps
- Gen1x2 = 10Gbps
- Gen2x2 = 20Gbps
- Gen3x2 = 40Gbps
:::

---

### フレーム

データは、`フレーム` という単位で通信される。1m sec 周期で繰り返し転送されている。
`フレーム` はいくつかの `トランザクション` からなり、`トランザクション` はいくつかの `パケット` からなる。

- フレーム
  - SOF(Start of Frame) というパケットで始まる

- トランザクション
  - パケットをいくつかのまとまりで意味のあるデータ転送の単位としたもの

- パケット
  - 通信の最小単位
  - いくつかの種類がある


---

#### パケットの種類

SYNCデータは同期をとるためのものなので、データとしては考えなくて良い

- パケット

  - SOP(Start of Packet)

  - SYNC(8bit)

    > 0b 0000 0001

  - PID(4bit + 4bit)
    - PID 自体は4bit
    - 後半 4bit はビット反転したもの

    | 4bits | 4bits     |
    | :---- | :-------- |
    | PID   | PIDの反転 |

    | 種別           | 名称  | コード | 反転コード | 定義                     |
    | :------------- | :---- | :----- | :--------- | :----------------------- |
    | SOF            | SOF   | 0101   | 1010       | フレームの開始           |
    | トークン       | OUT   | 0001   | 1110       | エンドポイントへの転送   |
    |                | IN    | 1001   | 0110       | ホストへの転送           |
    |                | SETUP | 1101   | 0010       | セットアップ             |
    | データ         | DATA0 | 0011   | 1100       | データパケット PID偶数   |
    |                | DATA1 | 1011   | 0100       | データパケット PID奇数   |
    | ハンドシェイク | ACK   | 0010   | 1101       | データ正常受信           |
    |                | NAK   | 1010   | 0101       | データ転送不成功         |
    |                | STALL | 1110   | 0001       | エンドポイントのストール |
    | スペシャル     | PRE   | 1100   | 0011       | ロースピード転送許可     |

  - Data(8bit x N)
    - 最大 1024 bit(N=128)
    - 末尾は、CRC(5bit or 16bit)

  - EOP(3bit End of Packet)


- 種類

  - SOF(Start of Frame)

    フレームの開始を表す

    | 8bits | 8bits | 11bits   | 5bits |
    | :---- | :---- | :------- | :---- |
    | SYNC  | PID   | Frame No | CRC   |

  - トークン

    ホストからデバイスへの要求

    | 8bits | 8bits | 7bits | 4bits | 5bits |
    | :---- | :---- | :---- | :---- | :---- |
    | SYNC  | PID   | ADDR  | ENDP  | CRC   |

  - データ

    トークンパケットに従って、ホスト or デバイス のどちらかからデータを送信

    | 8bits | 8bits | 8 x n (Max1024) **bytes** | 16bits |
    | :---- | :---- | :------------------------ | :----- |
    | SYNC  | PID   | Data                      | CRC    |

  - ハンドシェイク

    データパケットの受信を伝える。データパケットを受け取った側が返信する。

    | 8bits | 8bits |
    | :---- | :---- |
    | SYNC  | PID   |


---

#### トランザクション

- ホストからデバイスへのデータ送信

  ```mermaid
  sequenceDiagram
      participant Host
      participant Device
      Host-->>Device: トークンパケット(PID: OUT)
      Host->>Device: データパケット(PID: DATA0)
      Host->>Device: データパケット(PID: DATA1)
      Host->>Device: データパケット(PID: DATA0)
      Device-->>Host: ハンドシェイクパケット(PID: ACK)
  ```

- デバイスからホストへのデータ送信

  ```mermaid
  sequenceDiagram
      participant Host
      participant Device
      Host-->>Device: トークンパケット(PID: IN)
      Device->>Host: データパケット(PID: DATA0)
      Device->>Host: データパケット(PID: DATA1)
      Device->>Host: データパケット(PID: DATA0)
      Host-->>Device: ハンドシェイクパケット(PID: ACK)
  ```

- 準備ができていない場合

  ```mermaid
  sequenceDiagram
      participant Host
      participant Device
      Host-->>Device: トークンパケット(PID: IN)
      Device-->>Host: ハンドシェイクパケット(PID: NAK)
  ```

---

#### フレーム

トランザクションを束ねる。ホストは周期ごとにSOFパケットを送ってフレームを管理する。


---

#### 転送モード

- コントロール転送
  - セットアップステージ

    ```mermaid
    sequenceDiagram
        participant Host
        participant Device
        Host-->>Device: トークンパケット(PID: SETUP)
        Host->>Device: データパケット(PID: DATA0)
        Device-->>Host: ハンドシェイクパケット(PID: ACK)
    ```

  - データ構造

    | 名称          | 長さ(byte) | 機能                                                 |
    | :------------ | :--------- | :--------------------------------------------------- |
    | bmRequestType | 1          | リクエスト方向や受信対象を指定                       |
    | bRequest      | 1          | リクエスト内容                                       |
    | wValue        | 2          | リクエスト内容ごとに異なる引数                       |
    | wIndex        | 2          | リクエスト内容ごとに異なるインデックスやオフセット値 |
    | wLenght       | 2          | データステージの転送サイズ                           |

  - bmRequestType

    | ビット | 内容             | 値                                                         |
    | :----- | :--------------- | :--------------------------------------------------------- |
    | 7bit   | リクエスト方向   | 0: ホスト=>デバイス, 1: デバイス=>ホスト                   |
    | 6-5bit | リクエストタイプ | 0: 標準, 1:クラス, 2:ベンダー                              |
    | 4-0bit | 受信対象         | 0:デバイス, 1:インターフェース, 2:エンドポイント、3:その他 |

  - bRequest

    | 値  | 名称              | 機能                                                         |
    | :-- | :---------------- | :----------------------------------------------------------- |
    | 0   | GET_STATUS        | デバイス、エンドポイント、インターフェイスのステータスを取得 |
    | 5   | SET_ADDRESS       | デバイスにアドレスを割り当て                                 |
    | 6   | GET_DESCREPTOR    | デバイスのディスクリプタを取得                               |
    | 7   | SET_DESCREPTOR    | デバイスのディスクリプタを設定                               |
    | 8   | GET_CONFIGURATION | デイバスの設定を取得                                         |
    | 9   | SET_CONFIGURATION | デバイスの設定を割り当て |

  - データステージ

    ```mermaid
    sequenceDiagram
        participant Host
        participant Device
        Host-->>Device: トークンパケット(PID: IN)
        Device->>Host: データパケット(PID: DATA1)
        Device-->>Host: ハンドシェイクパケット(PID: ACK)
        Host-->>Device: トークンパケット(PID: IN)
        Device->>Host: データパケット(PID: DATA0)
        Device-->>Host: ハンドシェイクパケット(PID: ACK)
    ```

  - ステータスステージ

    ```mermaid
    sequenceDiagram
        participant Host
        participant Device
        Host-->>Device: トークンパケット(PID: OUT)
        Host->>Device: データパケット(PID: DATA0)
        Device-->>Host: ハンドシェイクパケット(PID: ACK)
    ```

- バルク転送
  - データステージのみ

- インタラプト転送
  - データステージのみ

- アイソクロナス転送
  - データステージのみ
  - ハンドシェイクパケットがない = 再送制御されない


---

### ディスクリプタ

- デバイスディスクリプタ(18byte)

  | フィールド         | 形式     | サイズ | 説明                               | 例            |
  | :----------------- | :------- | :----: | :--------------------------------- | :------------ |
  | bLength            | Number   |   1    | このディスクリプタのサイズ         | 0x12=18       |
  | bDescriptorType    | 定数     |   1    | ディスクリプタのタイプ             | 1=Device      |
  | bcdUSB             | BCD      |   2    | USB仕様のバージョン                | 0x0110=USB1.1 |
  | bDeviceClass       | Class    |   1    | クラスコード                       |               |
  | bDeviceSubClass    | SubClass |   1    | サブクラスコード                   |               |
  | bDeviceProtocol    | Protocol |   1    | プロトコルコード                   |               |
  | bMaxPacketSize     | Number   |   1    | エンドポイントの最大パケットサイズ | 64            |
  | idVendor           | ID       |   2    | ベンダーID                         | 0x0000        |
  | idProduct          | ID       |   2    | プロダクトID                       | 0x0001        |
  | bcdDevice          | BCD      |   2    | このデバイスのバージョン番号       | 0x0010        |
  | iManufacturer      | Index    |   1    | 製造元文字列のインデックス         | 0x01          |
  | iProduct           | Index    |   1    | プロダクト名文字列のインデックス   | 0x02          |
  | iSerialNumber      | Index    |   1    | シリアル番号                       | 0x03          |
  | bNumConfigurations | Number   |   1    | CONFIGURATIONの数                  |               |

- コンフィギュレーションディスクリプタ(9byte)

  | フィールド          | 形式   | サイズ | 説明                                         | 例              |
  | :------------------ | :----- | :----: | :------------------------------------------- | :-------------- |
  | bLength             | Number |   1    | このディスクリプタのサイズ                   | 0x09=9          |
  | bDescriptorType     | 定数   |   1    | ディスクリプタのタイプ                       | 2=Configuration |
  | wTotalLength        | Number |   2    | 複数のディスクリプタを返す場合は合計バイト数 | 0x003E=62       |
  | bNumInterfaces      | Number |   1    | インターフェースの数                         | 0x02=2          |
  | bConfigurationValue | Number |   1    | SET CONFIGURATION で使う値                   |                 |
  | iConfiguration      | Index  |   1    | この CONFIGURATION 文字列 のインデックス  |                 |
  | bmAttribute         | Bitmap |   1    | 設定特性のbit値                              | 0x80=バスパワー |
  | bMaxPower           | Number |   1    | 最大消費電力                                 | 0X64=200mA      |

  - bmAttribute

    | bit | 値                     |   内容    |
    | :-- | :--------------------- | :-------: |
    | 7   | 予約                   | 1（固定） |
    | 6   | セルフパワー           |           |
    | 5   | リモートウェークアップ |           |
    | 4-0 | 予約                   |  0(固定)  |

- インターフェースディスクリプタ(9byte)

  | フィールド         | 形式     | サイズ | 説明                                | 例                 |
  | :----------------- | :------- | :----: | :---------------------------------- | :----------------- |
  | bLength            | Number   |   1    | このディスクリプタのサイズ          | 0x09=9             |
  | bDescriptorType    | 定数     |   1    | ディスクリプタのタイプ              | 4=Interface        |
  | bInterfaceNumber   | Number   |   1    | インターフェイスの番号              | 0                  |
  | bAlternateSetting  | Number   |   1    | 代替設定の番号                      |                    |
  | bNumEndpoints      | Number   |   1    | エンドポイントの数                  | 1                  |
  | bInterfaceClass    | Class    |   1    | クラスコード                        | 0x03=HID           |
  | bInterfaceSubClass | SubClass |   1    | サブクラスコード                    | 0x01=BootInterface |
  | bInterfaceProtocol | Protocol |   1    | プロトコルコード                    | 0x01=Keyboard      |
  | iInterface         | Index    |   1    | この INTERFACE 文字列のインデックス |                    |

- エンドポイントディスクリプタ(7byte)

  | フィールド       | 形式           | サイズ | 説明                               | 例          |
  | :--------------- | :------------- | :----: | :--------------------------------- | :---------- |
  | bLength          | Number         |   1    | このディスクリプタのサイズ         | 0x07=7      |
  | bDescriptorType  | 定数           |   1    | ディスクリプタのタイプ             | 5=Endpoint  |
  | bEndpointAddress | エンドポイント |   1    | エンドポイントアドレスと方向       | 0x81=IN,EP1 |
  | bmAttribute      | Bitmap         |   1    | エンドポイントの属性               | 0x03        |
  | wMaxPacketSize   | Number         |   2    | エンドポイントの最大パケットサイズ | 0x0008      |
  | bInterval        | Number         |   1    | データ転送のポーリング間隔         | 10          |

  - bmEndpointAddress

    | bit | 値                             |     内容      |
    | :-- | :----------------------------- | :-----------: |
    | 7   | エンドポイントのデータ送信方向 | 1: IN, 0: OUT |
    | 6-4 | 予約                           |    0(固定)    |
    | 3-0 | エンドポイント番号             |    0 ～ 15    |

  - bmAttribute

    | bit | 値                                   | 内容                                                                                                                     |
    | :-- | :----------------------------------- | :----------------------------------------------------------------------------------------------------------------------- |
    | 7-6 | 予約                                 | 0(固定)                                                                                                                  |
    | 5-4 | 使用タイプ（アイソクロナス転送のみ） | 00: データエンドポイント<br>01: フィードバックエンドポイント<br>10: インプリシットフィードバック<br>データエンドポイント |
    | 3-2 | 同期タイプ（アイソクロナス転送のみ） | 00: 同期無し<br>01: 非同期<br>10: Adaptive<br>11: 同期                                                                   |
    | 1-0 | 転送タイプ                           | 00:コントロール<br>01: アイソクロナス<br>10: バルク<br>11: インタラプト                                                  |

- ストリングディスクリプタ(任意)

## 用語など

- ホスト(Hose)
  - 制御する側
  - 転送は必ずホストから開始される

- デバイス(Device)
  制御される側

- エンドポイント(Endpoint: EP)
  - 仮想的な通信端子
  - デバイスは複数の EP をもつ
  - EP0 は必須で、Control 転送をする

- パイプ(Pipe)
  - ホストとデバイスのエンドポイントを結ぶ通信経路
  - 片方向のみ通信できる

- 転送方式
  - 制御情報
    - コントロール(Control): デバイスの状態を問い合わせたり、設定したりする
  - データ転送
    - バルク(Bulk)              : 大量のデータを転送する
    - インタラプト(Interrupt)    : 任意のタイミングで少量のデータを転送する
    - アイソクロナス(Isochronous): リアルタイム性のあるデータを転送する

- プラグ＆プレイ(Plug and Play: PnP)
  - デバイス検出
    - D+/D- の電圧で検知
    - ホスト側がRESET状態を一定期間通知
    - デバイス側はRESET処理し、コントロール転送できることを通知
  - コントロール転送でデバイス情報取得し、アドレスを割り当て
    - ホストは、デバイスのデバイスディスクリプタを要求する
    - ホストは、アドレスを通知する
  - デバイスの詳細情報を取得
  - データ通信開始

- ディスクリプタ
  情報のまとまり
  - デバイスディスクリプタ
  - コンフィギュレーションディスクリプタ
  - インターフェースディスクリプタ
  - エンドポイントディスクリプタ
  - ストリングディスクリプタ
  - クラス固有ディスクリプタ

- デバイスクラス